<!DOCTYPE html><html> <head><meta charset="utf-8"><title>Streaming videos from Google Drive - 2nd attempt | Hi, I'm Nhân</title><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" href="/theme/fonts/fonts.css"><link rel="stylesheet" href="/theme/css/zenburn.css"><link rel="stylesheet" href="/theme/css/main.css"><link rel="stylesheet" href="/theme/css/article.css"><meta property="og:title" content="Streaming videos from Google Drive - 2nd attempt"><meta property="og:description" content="TL;DR: I improved the Google Drive video streaming experience mentioned in an earlier blog post. It now works like this on an Android phone with mpv-android installed: The longer version follows. Previously I was writing a proxy of sorts that adapted..."><meta property="og:image" content="https://hi.imnhan.com/images/keyboard-warrior.jpg"></head> <!--

Why hello there, source viewer. Here's a dragon for no particular reason:

       ^                       ^
       |\   \        /        /|
      /  \  |\__  __/|       /  \_
     / /\ \ \ _ \/ _ /      /    \_
    / / /\ \ {*}\/{*}      /  / \ \_
    | | | \ \( (00) )     /  // |\ \_
    | | | |\ \(V""V)\    /  / | || \|
    | | | | \ |^--^| \  /  / || || ||
   / / /  | |( WWWW__ \/  /| || || ||
  | | | | | |  \______\  / / || || ||
  | | | / | | )|______\ ) | / | || ||
  / / /  / /  /______/   /| \ \ || ||
 / / /  / /  /\_____/  |/ /__\ \ \ \ \_
 | | | / /  /\______/    \   \__| \ \ \_
 | | | | | |\______ __    \_    \__|_| \_
 | | ,___ /\______ _  _     \_       \  |
 | |/    /\_____  /    \      \__     \ |    /\_
 |/ |   |\______ |      |        \___  \ |__/  \_
 v  |   |\______ |      |            \___/     |
    |   |\______ |      |                    __/
     \   \________\_    _\               ____/
   __/   /\_____ __/   /   )\_,      _____/
  /  ___/  \____/  ___/___)    \______/
  VVV  V        VVV  V

(ripped off from http://www.retrojunkie.com/asciiart/myth/dragons.htm)

--> <body> <div id="main"> <header role="banner"><h1 id="site-name"><a href="/">Hi, I'm Nhân</a></h1> <h2 id="site-subtitle">and this is my humble corner on the interwebs.</h2></header> <hr> <nav role="navigation"><ul class="navbar" id="left-navbar"> <li><a href="/">Blog</a></li> <li><a href="https://hi.imnhan.com/about/">About</a></li> </ul> <ul class="navbar" id="right-navbar"> <li> <a href="/feeds/atom.xml">Feed</a> </li> </ul></nav> <hr id="hr-nav"> <div id="content"> <div class="article-content"> <article> <h1 class="article-title"> Streaming videos from Google Drive - 2nd attempt </h1> <time datetime="2020-06-10 08:25:00+07:00"> June 10, 2020 </time> <p><strong><span class="caps">TL</span>;<span class="caps">DR</span>:</strong> I improved the Google Drive video streaming experience mentioned in an <a href="/posts/towards-an-acceptable-video-playing-experience/">earlier blog post</a>. It now works like this on an Android phone with mpv-android&nbsp;installed:</p> <video controls> <source src="https://junk.imnhan.com/gflick-phone-demo.mp4" type="video/mp4"> </video> <p>The longer version&nbsp;follows.</p> <p><a href="/posts/towards-an-acceptable-video-playing-experience/">Previously</a> I was writing a proxy of sorts that adapted Google Drive&#8217;s &#8220;bearer token&#8221; auth to the more widely supported &#8220;basic auth&#8221; so I could watch movies. I was stuck at the point where desktop video players could stream just fine while their android ports would do&nbsp;nothing.</p> <p>Turns out it was a <span class="caps">TLS</span> issue: I configured nginx to use TLSv1.3 which is the latest and greatest, but mpv/vlc on android came bundled with older <span class="caps">TLS</span> libraries which only supported up to v1.2. This led me to another surprise: the nginx config generated by <a href="https://ssl-config.mozilla.org/#server=nginx&version=1.17.7&config=intermediate&openssl=1.1.1d&guideline=5.4">Mozilla&#8217;s <span class="caps">SSL</span> Configuration Generator</a>, while advertised to support older TLSes (in either <code>Intermediate</code> or <code>Old</code> mode), didn&#8217;t actually work in practice. <a href="https://www.ssllabs.com/ssltest/"><span class="caps">SSL</span> tests</a> always reported that the only working <span class="caps">SSL</span>/<span class="caps">TLS</span> protocol was&nbsp;TLSv1.3.</p> <blockquote> <p>The issue was pinpointed thanks to reading the android device&#8217;s logcat output. Did you know that in order to read logcat you only need to install some <a href="https://pkgs.org/search/?q=android-tools">8-megabyte package</a> instead of the whole android studio behemoth? I do&nbsp;now!</p> </blockquote> <p>As luck would have it, <a href="https://caddyserver.com/v2">Caddy v2</a> was recently released and they even provided a Debian repo! I had used Caddy v1 in the past but my impression was that despite their pitch of a &#8220;download and run&#8221; experience, actual <a href="https://github.com/caddyserver/caddy/tree/v1.0.4/dist/init/linux-systemd">extra work</a> was required - it was straightforward and well-documented, but it was still extra busywork. This combined with the hassle of having to compile my own binary bounced me back to nginx. Both of these issues have been addressed in v2, so there&#8217;s really no reason to keep wrestling with nginx + certbot&nbsp;anymore.</p> <blockquote> <p>On that note, to this day I still haven&#8217;t figured out how to make the nginx/certbot combo play nice with ansible. Problem is, certbot&#8217;s nginx plugin wants to mutate the nginx config file itself, so the nginx configs before vs after certbot runs are decidedly different. This requires ridiculous gymnastics to mold into an ansible play - and don&#8217;t even get me started on multi-site setups. A <a href="https://github.com/nhanb/gflick/blob/4dd3dbdbdfe8de66337ed0a2fe420dd0e1d72f39/caddy/gflick">Caddyfile</a>, on the other hand, simply gets out of your&nbsp;way.</p> </blockquote> <p>Now that <span class="caps">TLS</span> is settled, I also made some changes to the usage&nbsp;flow:</p> <h3>Authentication</h3> <p>The authentication responsibility has been moved from nginx/caddy to the python application itself to enable more fine-grained&nbsp;control:</p> <p>Every route, except for the video-serving <code>/v/*</code>, requires a user_token cookie. If it doesn&#8217;t exist, redirect to <code>/login</code>, which will let user submit a password in order to get the user token back. User token is a 128-byte string that&#8217;s regenerated every time the python script restarts. I should probably write a janitor script to periodically regenerate it&nbsp;instead.</p> <p>When user navigates to a video, a unique 128-byte slug is generated just for it and the video can now be directly streamed at <code>/v/&lt;slug&gt;</code>, with no authentication required. Currently slugs older than 1 day are wiped on python application startup, but then, like user token, I should probably stop relying on the script restarting to do cleanup&nbsp;operations.</p> <p>With this setup I can freely share the <code>/v/&lt;slug&gt;</code> url to other people without leaking any auth credentials, and they eventually expire too. There&#8217;s tuning to be done for expiration mechanisms but the foundations are&nbsp;there.</p> <h3>Aesthetics</h3> <p>The web interface has been revamped to make it easier for <strike>fat-fingered people on $current_year&#8217;s trendy stupidly thin</strike> phones. Also present are folder icons and thumbnails, so it finally gives me everything I want from Google Drive&#8217;s web <span class="caps">UI</span> and nothing that I don&#8217;t. Fun fact: it works on <a href="https://www.netsurf-browser.org/">NetSurf</a> too (but then again why wouldn&#8217;t&nbsp;it?).</p> <p><img alt="gflick screenshot" src="/images/gflick_01_mobile.png"></p> <h2>What&#8217;s the&nbsp;catch?</h2> <p><strong>Client device is solely responsible for decoding the raw file.</strong> This is both a blessing and a curse: We are guaranteed original quality but if the file was encoded with newer codecs (h265, av1, etc.) we&#8217;re stuck with inefficient software decoding and some devices are just too weak to do so smoothly. My Amazon Fire <span class="caps">HD</span> 10 tablet suffers greatly when playing 1080p 10bit anime. Curiously, my crappy Mi A3 phone yields better performance, although stutters still happen here and there. More modest h264 movies play flawlessly, for what it&#8217;s&nbsp;worth.</p> <p><strong>This is a proof of concept and the codebase quality reflects that.</strong> I&#8217;m in the middle of cleaning it up for pypi friendliness and xdg compliance, but currently stuck when porting from std&#8217;s http server to bottlepy. The current dirty codebase is working fine for me so I&#8217;m in no hurry&nbsp;though&#8230;</p> <h2>In&nbsp;conclusion</h2> <p>I&#8217;m happy with how things turned out: I have <a href="https://drive.google.com/">zero-maintenance unlimited cloud storage</a> for movies and an effortless streaming experience that requires virtually no client-side setup - just install a browser and streaming-capable video player, then everything works out of the box. This is <em>almost</em> as convenient as Netflix, but without the stupid quality restriction on non-sanctioned devices. I probably need to upgrade to a beefier tablet&nbsp;though.</p> </article> </div> <hr id="hr-comment"> <h2>Comments</h2> <div id="disqus_thread"> <button id="showCommentBtn">Show comments via Disqus</button> <noscript><br>(enable JavaScript first though)</noscript> </div> <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    // These need to be defined in the outermost scope, apparently.
    var disqus_shortname = 'nerdyweekly';
    var disqus_identifier = '/posts/streaming-videos-from-google-drive-2nd-attempt/';
    var disqus_url = 'https://hi.imnhan.com/posts/streaming-videos-from-google-drive-2nd-attempt/';
    var disqus_title = 'Streaming videos from Google Drive - 2nd attempt';

    document.querySelector('#showCommentBtn').addEventListener('click', function (event) {
        // Immediate visual feedback is always good:
        event.target.disabled = true;
        event.target.innerHTML = 'Loading comments...';

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    });
</script> </div> <hr id="hr-footer"> <footer>&copy; 2013–2020 Bùi Thành Nhân <br> Built with &#9829; and probably too much <a target="_blank" rel="noopener" href="https://trungnguyenlegend.com/g7/">G7 X2</a>. </footer> </div> </body> </html>